export default {
  async fetch(request, env, ctx) {
    const url = new URL(request.url);
    const path = url.pathname;

    // Ù¾Ø§Ø³Ø® JSON
    const jsonResponse = (data, status = 200) => {
      return new Response(JSON.stringify(data), {
        status: status,
        headers: {
          'Content-Type': 'application/json',
          'Access-Control-Allow-Origin': '*',
          'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
          'Access-Control-Allow-Headers': 'Content-Type'
        }
      });
    };

    // Ù¾Ø§Ø³Ø® HTML
    const htmlResponse = (content) => {
      return new Response(content, {
        headers: {
          'Content-Type': 'text/html; charset=utf-8'
        }
      });
    };

    // CORS preflight
    if (request.method === 'OPTIONS') {
      return new Response(null, {
        headers: {
          'Access-Control-Allow-Origin': '*',
          'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
          'Access-Control-Allow-Headers': 'Content-Type'
        }
      });
    }

    try {
      // ğŸ  ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ - Ù¾Ø³Øª Û±Û²Û¶
      if (path === '/' || path === '') {
        const html = `
          <!DOCTYPE html>
          <html dir="rtl" lang="fa">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>ğŸš€ Ø³ÛŒØ³ØªÙ… Ù¾Ø³Øª Û±Û²Û¶ - ÙØ¹Ø§Ù„</title>
            <style>
              * { margin: 0; padding: 0; box-sizing: border-box; }
              body { 
                font-family: 'Tahoma', 'Arial', sans-serif;
                direction: rtl;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                color: #333;
                padding: 20px;
              }
              .container { 
                max-width: 1200px;
                margin: 0 auto;
              }
              .card {
                background: white;
                border-radius: 20px;
                padding: 40px;
                box-shadow: 0 20px 40px rgba(0,0,0,0.1);
                margin: 20px 0;
                text-align: center;
              }
              .success {
                color: #28a745;
                font-weight: bold;
                font-size: 24px;
                background: #d4edda;
                padding: 10px 20px;
                border-radius: 10px;
                display: inline-block;
                margin: 20px 0;
              }
              .btn {
                display: inline-block;
                padding: 15px 30px;
                margin: 10px;
                background: #007bff;
                color: white;
                text-decoration: none;
                border-radius: 10px;
                border: none;
                cursor: pointer;
                font-size: 16px;
                transition: all 0.3s;
              }
              .btn:hover {
                background: #0056b3;
                transform: translateY(-2px);
              }
            </style>
          </head>
          <body>
            <div class="container">
              <div class="card">
                <h1>ğŸ‰ Ø³ÛŒØ³ØªÙ… Ù¾Ø³Øª Û±Û²Û¶ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ÙØ¹Ø§Ù„ Ø´Ø¯!</h1>
                <div class="success">âœ… Ø§ÛŒÙ† Ù†Ø³Ø®Ù‡ Ø¬Ø¯ÛŒØ¯ Ø§Ø² Ø·Ø±ÛŒÙ‚ GitHub Actions Ù…Ø³ØªÙ‚Ø± Ø´Ø¯Ù‡ Ø§Ø³Øª</div>
                
                <p><strong>ØªØ§Ø±ÛŒØ® Ø§Ø³ØªÙ‚Ø±Ø§Ø±:</strong> ${new Date().toLocaleString('fa-IR')}</p>
                <p><strong>Ø´Ù…Ø§Ø±Ù‡ Ù¾Ø³Øª:</strong> Û±Û²Û¶</p>
                <p><strong>ÙˆØ±Ú˜Ù†:</strong> Û².Û°.Û°</p>
                <p><strong>Ø±ÙˆØ´ Ø§Ø³ØªÙ‚Ø±Ø§Ø±:</strong> GitHub Actions + Wrangler</p>
                
                <div style="margin: 30px 0; padding: 20px; background: #e7f3ff; border-radius: 10px;">
                  <h3>ğŸ“‹ endpointÙ‡Ø§ÛŒ ÙØ¹Ø§Ù„:</h3>
                  <p><a href="/chat" class="btn">ğŸ’¬ Ø³ÛŒØ³ØªÙ… Ú†Øª</a></p>
                  <p><a href="/admin" class="btn">ğŸ¯ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª</a></p>
                  <p><a href="/api/status" class="btn">ğŸ“Š ÙˆØ¶Ø¹ÛŒØª Ø³ÛŒØ³ØªÙ…</a></p>
                  <p><a href="/api/chat/send" class="btn">ğŸ”Œ API Ú†Øª</a></p>
                </div>

                <div style="margin-top: 30px;">
                  <h3>ğŸª ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ø³ÛŒØ³ØªÙ…:</h3>
                  <p>â€¢ Ú†Øª Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø¨Ø§ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø²Ø¨Ø§Ù† Ø·Ø¨ÛŒØ¹ÛŒ</p>
                  <p>â€¢ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ù¾ÛŒØ´Ø±ÙØªÙ‡</p>
                  <p>â€¢ APIÙ‡Ø§ÛŒ Ú©Ø§Ù…Ù„ REST</p>
                  <p>â€¢ Ø·Ø±Ø§Ø­ÛŒ ÙˆØ§Ú©Ù†Ø´â€ŒÚ¯Ø±Ø§ Ùˆ ÙØ§Ø±Ø³ÛŒ</p>
                  <p>â€¢ Ù¾Ø³Øª Ø´Ù…Ø§Ø±Ù‡: Û±Û²Û¶</p>
                </div>
              </div>
            </div>
          </body>
          </html>
        `;
        return htmlResponse(html);
      }

      // ğŸ”Œ API Ú†Øª - Ù¾Ø³Øª Û±Û²Û¶
      if (path === '/api/chat/send' && request.method === 'POST') {
        const { message = '' } = await request.json();
        
        let response = "Ø³Ù„Ø§Ù…! Ø³ÛŒØ³ØªÙ… Ù¾Ø³Øª Û±Û²Û¶ Ø¯Ø± Ø®Ø¯Ù…Øª Ø´Ù…Ø§Ø³Øª. Ú†Ú¯ÙˆÙ†Ù‡ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ù… Ú©Ù…Ú© Ú©Ù†Ù…ØŸ";
        
        if (message.includes('Û±Û²Û¶') || message.includes('126')) {
          response = "âœ… Ø¨Ù„Ù‡! Ø§ÛŒÙ† Ø³ÛŒØ³ØªÙ… Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ù¾Ø³Øª Ø´Ù…Ø§Ø±Ù‡ Û±Û²Û¶ Ù…ÛŒâ€ŒØ¨Ø§Ø´Ø¯. Ø³ÛŒØ³ØªÙ… Ú©Ø§Ù…Ù„Ø§Ù‹ ÙØ¹Ø§Ù„ Ùˆ Ø¨Ù‡â€ŒØ±ÙˆØ² Ø§Ø³Øª.";
        }
        if (message.includes('Ø³Ù„Ø§Ù…')) {
          response = "Ø³Ù„Ø§Ù…! Ø¨Ù‡ Ø³ÛŒØ³ØªÙ… Ù‡ÙˆØ´Ù…Ù†Ø¯ Ù¾Ø³Øª Û±Û²Û¶ Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯. ğŸŒŸ";
        }

        return jsonResponse({
          success: true,
          user_message: message,
          bot_response: response,
          post_id: 126,
          timestamp: new Date().toISOString(),
          version: "2.0.0",
          deployment: "github-actions"
        });
      }

      // ğŸ“Š ÙˆØ¶Ø¹ÛŒØª Ø³ÛŒØ³ØªÙ… - Ù¾Ø³Øª Û±Û²Û¶
      if (path === '/api/status') {
        return jsonResponse({
          status: "active",
          service: "social-media-intelligence-platform",
          version: "2.0.0",
          post_id: 126,
          timestamp: new Date().toISOString(),
          deployment_method: "github-actions",
          endpoints: {
            home: "/",
            chat: "/chat",
            admin: "/admin", 
            api_chat: "/api/chat/send",
            api_status: "/api/status"
          },
          message: "Ø³ÛŒØ³ØªÙ… Ù¾Ø³Øª Û±Û²Û¶ Ø§Ø² Ø·Ø±ÛŒÙ‚ GitHub Actions Ù…Ø³ØªÙ‚Ø± Ø´Ø¯Ù‡ Ø§Ø³Øª"
        });
      }

      // Ø¯Ø± ÙØ§ÛŒÙ„ src/index.js - Ø¨Ø®Ø´ Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ /chat
if (path === '/chat') {
  const html = `
    <!DOCTYPE html>
    <html dir="rtl" lang="fa">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ğŸ’¬ Ú†Øª Ù‡ÙˆØ´Ù…Ù†Ø¯ Ù¾ÛŒØ´Ø±ÙØªÙ‡ - Ù¾Ø³Øª Û±Û²Û¶</title>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            :root {
                --primary-color: #007bff;
                --secondary-color: #6c757d;
                --success-color: #28a745;
                --danger-color: #dc3545;
                --warning-color: #ffc107;
                --info-color: #17a2b8;
                --light-color: #f8f9fa;
                --dark-color: #343a40;
                --bg-color: #ffffff;
                --text-color: #333333;
                --border-color: #dee2e6;
                --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                --radius: 12px;
            }

            [data-theme="dark"] {
                --bg-color: #1a1a1a;
                --text-color: #ffffff;
                --border-color: #444444;
                --light-color: #2d2d2d;
                --shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            }

            body {
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                direction: rtl;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                color: var(--text-color);
                transition: all 0.3s ease;
            }

            .container {
                max-width: 1200px;
                margin: 0 auto;
                padding: 20px;
                height: 100vh;
                display: flex;
                flex-direction: column;
            }

            /* Ù‡Ø¯Ø± Ú†Øª */
            .chat-header {
                background: var(--bg-color);
                padding: 20px;
                border-radius: var(--radius) var(--radius) 0 0;
                box-shadow: var(--shadow);
                display: flex;
                justify-content: space-between;
                align-items: center;
                border-bottom: 1px solid var(--border-color);
            }

            .chat-info {
                display: flex;
                align-items: center;
                gap: 15px;
            }

            .avatar {
                width: 50px;
                height: 50px;
                border-radius: 50%;
                background: linear-gradient(135deg, var(--primary-color), #0056b3);
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-weight: bold;
                font-size: 20px;
            }

            .user-status {
                display: flex;
                align-items: center;
                gap: 8px;
                font-size: 14px;
                color: var(--success-color);
            }

            .status-dot {
                width: 8px;
                height: 8px;
                border-radius: 50%;
                background: var(--success-color);
                animation: pulse 2s infinite;
            }

            @keyframes pulse {
                0% { opacity: 1; }
                50% { opacity: 0.5; }
                100% { opacity: 1; }
            }

            .chat-actions {
                display: flex;
                gap: 10px;
            }

            .btn {
                padding: 10px 15px;
                border: none;
                border-radius: var(--radius);
                cursor: pointer;
                transition: all 0.3s ease;
                display: flex;
                align-items: center;
                gap: 8px;
                font-size: 14px;
                background: var(--light-color);
                color: var(--text-color);
            }

            .btn:hover {
                transform: translateY(-2px);
                box-shadow: var(--shadow);
            }

            .btn-primary {
                background: var(--primary-color);
                color: white;
            }

            /* Ø¨Ø¯Ù†Ù‡ Ú†Øª */
            .chat-container {
                flex: 1;
                background: var(--bg-color);
                display: flex;
                flex-direction: column;
                border-radius: 0 0 var(--radius) var(--radius);
                box-shadow: var(--shadow);
                overflow: hidden;
            }

            .messages-container {
                flex: 1;
                padding: 20px;
                overflow-y: auto;
                background: var(--light-color);
                display: flex;
                flex-direction: column;
                gap: 15px;
            }

            /* Ø§Ø³ØªØ§ÛŒÙ„ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ */
            .message {
                max-width: 70%;
                padding: 15px;
                border-radius: var(--radius);
                position: relative;
                animation: messageSlide 0.3s ease;
            }

            @keyframes messageSlide {
                from {
                    opacity: 0;
                    transform: translateY(20px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .message-user {
                align-self: flex-end;
                background: var(--primary-color);
                color: white;
                border-bottom-right-radius: 5px;
            }

            .message-bot {
                align-self: flex-start;
                background: var(--bg-color);
                color: var(--text-color);
                border: 1px solid var(--border-color);
                border-bottom-left-radius: 5px;
            }

            .message-time {
                font-size: 12px;
                opacity: 0.7;
                margin-top: 5px;
                display: block;
            }

            .message-actions {
                position: absolute;
                top: -25px;
                right: 10px;
                background: var(--bg-color);
                border-radius: 20px;
                padding: 5px;
                box-shadow: var(--shadow);
                display: none;
            }

            .message:hover .message-actions {
                display: flex;
            }

            .action-btn {
                background: none;
                border: none;
                cursor: pointer;
                padding: 5px;
                border-radius: 50%;
                transition: background 0.3s;
            }

            .action-btn:hover {
                background: var(--light-color);
            }

            /* Ù†ÙˆØ§Ø± ÙˆØ±ÙˆØ¯ Ù¾ÛŒØ§Ù… */
            .input-container {
                padding: 20px;
                background: var(--bg-color);
                border-top: 1px solid var(--border-color);
                display: flex;
                gap: 10px;
                align-items: flex-end;
            }

            .input-wrapper {
                flex: 1;
                display: flex;
                flex-direction: column;
                gap: 10px;
            }

            .message-input {
                width: 100%;
                padding: 15px;
                border: 1px solid var(--border-color);
                border-radius: var(--radius);
                background: var(--bg-color);
                color: var(--text-color);
                font-size: 16px;
                resize: none;
                min-height: 60px;
                max-height: 120px;
                transition: border-color 0.3s;
            }

            .message-input:focus {
                outline: none;
                border-color: var(--primary-color);
            }

            .input-actions {
                display: flex;
                gap: 10px;
                align-items: center;
            }

            .file-input {
                display: none;
            }

            .file-label {
                cursor: pointer;
                padding: 10px;
                border-radius: 50%;
                transition: background 0.3s;
            }

            .file-label:hover {
                background: var(--light-color);
            }

            .send-btn {
                background: var(--primary-color);
                color: white;
                border: none;
                padding: 12px 25px;
                border-radius: var(--radius);
                cursor: pointer;
                transition: all 0.3s;
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .send-btn:hover {
                background: #0056b3;
                transform: translateY(-2px);
            }

            .send-btn:disabled {
                background: var(--secondary-color);
                cursor: not-allowed;
                transform: none;
            }

            /* Ù†ÙˆØ§Ø± Ú©Ù†Ø§Ø±ÛŒ */
            .sidebar {
                position: fixed;
                left: -300px;
                top: 0;
                width: 300px;
                height: 100vh;
                background: var(--bg-color);
                box-shadow: var(--shadow);
                transition: left 0.3s ease;
                z-index: 1000;
                padding: 20px;
                overflow-y: auto;
            }

            .sidebar.open {
                left: 0;
            }

            .sidebar-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 20px;
                padding-bottom: 15px;
                border-bottom: 1px solid var(--border-color);
            }

            .sidebar-section {
                margin-bottom: 25px;
            }

            .sidebar-title {
                font-size: 16px;
                margin-bottom: 15px;
                color: var(--primary-color);
            }

            .theme-switch {
                display: flex;
                gap: 10px;
            }

            .theme-option {
                flex: 1;
                text-align: center;
                padding: 10px;
                border: 1px solid var(--border-color);
                border-radius: var(--radius);
                cursor: pointer;
                transition: all 0.3s;
            }

            .theme-option.active {
                background: var(--primary-color);
                color: white;
                border-color: var(--primary-color);
            }

            .search-box {
                width: 100%;
                padding: 10px;
                border: 1px solid var(--border-color);
                border-radius: var(--radius);
                background: var(--bg-color);
                color: var(--text-color);
            }

            /* ÙˆØ¶Ø¹ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø³ÛŒØ³ØªÙ… */
            .typing-indicator {
                display: none;
                align-self: flex-start;
                background: var(--bg-color);
                padding: 10px 15px;
                border-radius: var(--radius);
                border: 1px solid var(--border-color);
                font-style: italic;
                color: var(--secondary-color);
            }

            .typing-indicator.show {
                display: block;
            }

            .connection-status {
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 10px 15px;
                border-radius: var(--radius);
                background: var(--success-color);
                color: white;
                box-shadow: var(--shadow);
                z-index: 1001;
                display: none;
            }

            .connection-status.show {
                display: block;
                animation: slideIn 0.3s ease;
            }

            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }

            /* Ø±Ø³Ù¾Ø§Ù†Ø³ÛŒÙˆ */
            @media (max-width: 768px) {
                .container {
                    padding: 10px;
                }

                .message {
                    max-width: 85%;
                }

                .chat-header {
                    padding: 15px;
                }

                .input-container {
                    padding: 15px;
                }

                .sidebar {
                    width: 100%;
                    left: -100%;
                }
            }

            /* Ø§Ø³Ú©Ø±ÙˆÙ„ Ø¨Ø§Ø± Ø³ÙØ§Ø±Ø´ÛŒ */
            .messages-container::-webkit-scrollbar {
                width: 6px;
            }

            .messages-container::-webkit-scrollbar-track {
                background: var(--light-color);
            }

            .messages-container::-webkit-scrollbar-thumb {
                background: var(--secondary-color);
                border-radius: 3px;
            }

            .messages-container::-webkit-scrollbar-thumb:hover {
                background: var(--primary-color);
            }
        </style>
    </head>
    <body>
        <div class="container">
            <!-- Ù‡Ø¯Ø± Ú†Øª -->
            <div class="chat-header">
                <div class="chat-info">
                    <div class="avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div>
                        <h2>Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯</h2>
                        <div class="user-status">
                            <div class="status-dot"></div>
                            <span>Ø¢Ù†Ù„Ø§ÛŒÙ†</span>
                        </div>
                    </div>
                </div>
                <div class="chat-actions">
                    <button class="btn" onclick="toggleSidebar()">
                        <i class="fas fa-cog"></i>
                        ØªÙ†Ø¸ÛŒÙ…Ø§Øª
                    </button>
                    <button class="btn btn-primary" onclick="clearChat()">
                        <i class="fas fa-trash"></i>
                        Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ú†Øª
                    </button>
                </div>
            </div>

            <!-- Ø¨Ø¯Ù†Ù‡ Ú†Øª -->
            <div class="chat-container">
                <div class="messages-container" id="messagesContainer">
                    <!-- Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
                    <div class="message message-bot">
                        <div class="message-content">
                            Ø³Ù„Ø§Ù…! ğŸ‘‹ Ø¨Ù‡ Ø³ÛŒØ³ØªÙ… Ú†Øª Ù‡ÙˆØ´Ù…Ù†Ø¯ Ù¾Ø³Øª Û±Û²Û¶ Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯. Ù…Ù† Ø§ÛŒÙ†Ø¬Ø§Ù… ØªØ§ Ø¨Ù‡ Ø´Ù…Ø§ Ú©Ù…Ú© Ú©Ù†Ù….
                        </div>
                        <span class="message-time">${new Date().toLocaleTimeString('fa-IR')}</span>
                    </div>
                </div>

                <!-- Ù†Ø´Ø§Ù†Ú¯Ø± ØªØ§ÛŒÙ¾ -->
                <div class="typing-indicator" id="typingIndicator">
                    <i class="fas fa-ellipsis-h"></i>
                    Ø¯Ø± Ø­Ø§Ù„ ØªØ§ÛŒÙ¾...
                </div>

                <!-- Ù†ÙˆØ§Ø± ÙˆØ±ÙˆØ¯ Ù¾ÛŒØ§Ù… -->
                <div class="input-container">
                    <div class="input-wrapper">
                        <textarea 
                            class="message-input" 
                            id="messageInput" 
                            placeholder="Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..."
                            rows="1"
                        ></textarea>
                        <div class="input-actions">
                            <input type="file" id="fileInput" class="file-input" accept="image/*,.pdf,.doc,.docx">
                            <label for="fileInput" class="file-label">
                                <i class="fas fa-paperclip"></i>
                            </label>
                            <button class="btn" onclick="toggleTheme()">
                                <i class="fas fa-moon"></i>
                            </button>
                            <button class="send-btn" id="sendButton" onclick="sendMessage()">
                                <i class="fas fa-paper-plane"></i>
                                Ø§Ø±Ø³Ø§Ù„
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ÙˆØ¶Ø¹ÛŒØª Ø§ØªØµØ§Ù„ -->
            <div class="connection-status" id="connectionStatus">
                <i class="fas fa-wifi"></i>
                Ù…ØªØµÙ„ Ø´Ø¯
            </div>
        </div>

        <!-- Ù†ÙˆØ§Ø± Ú©Ù†Ø§Ø±ÛŒ ØªÙ†Ø¸ÛŒÙ…Ø§Øª -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h3>ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ú†Øª</h3>
                <button class="btn" onclick="toggleSidebar()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="sidebar-section">
                <h4 class="sidebar-title">ØªÙ… Ù†Ù…Ø§ÛŒØ´</h4>
                <div class="theme-switch">
                    <div class="theme-option active" data-theme="light" onclick="setTheme('light')">
                        <i class="fas fa-sun"></i>
                        Ø±ÙˆØ´Ù†
                    </div>
                    <div class="theme-option" data-theme="dark" onclick="setTheme('dark')">
                        <i class="fas fa-moon"></i>
                        ØªØ§Ø±ÛŒÚ©
                    </div>
                </div>
            </div>

            <div class="sidebar-section">
                <h4 class="sidebar-title">Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ú†Øª</h4>
                <input type="text" class="search-box" id="searchBox" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ù…Ú©Ø§Ù„Ù…Ø§Øª...">
            </div>

            <div class="sidebar-section">
                <h4 class="sidebar-title">Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø³ÛŒØ³ØªÙ…</h4>
                <div style="font-size: 14px; line-height: 1.6;">
                    <p><strong>Ù¾Ø³Øª:</strong> Û±Û²Û¶</p>
                    <p><strong>ÙˆØ±Ú˜Ù†:</strong> Û².Û±.Û°</p>
                    <p><strong>Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ:</strong> ${new Date().toLocaleDateString('fa-IR')}</p>
                    <p><strong>ÙˆØ¶Ø¹ÛŒØª:</strong> <span style="color: var(--success-color);">ÙØ¹Ø§Ù„ âœ…</span></p>
                </div>
            </div>

            <div class="sidebar-section">
                <h4 class="sidebar-title">Ø±Ø§Ù‡Ù†Ù…Ø§</h4>
                <div style="font-size: 14px; line-height: 1.6;">
                    <p>â€¢ Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø§Ø² Ø¯Ú©Ù…Ù‡ Ø§Ø±Ø³Ø§Ù„ ÛŒØ§ Enter Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯</p>
                    <p>â€¢ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯</p>
                    <p>â€¢ Ú†Øª Ø¨Ù‡ ØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯</p>
                    <p>â€¢ Ø§Ø² Ø¯Ú©Ù…Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¨Ø±Ø§ÛŒ Ø´Ø®ØµÛŒâ€ŒØ³Ø§Ø²ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯</p>
                </div>
            </div>
        </div>

        <script>
            // Ù…Ø¯ÛŒØ±ÛŒØª ÙˆØ¶Ø¹ÛŒØª
            class ChatManager {
                constructor() {
                    this.messages = JSON.parse(localStorage.getItem('chatMessages')) || [];
                    this.theme = localStorage.getItem('chatTheme') || 'light';
                    this.isOnline = true;
                    this.init();
                }

                init() {
                    this.setTheme(this.theme);
                    this.loadMessages();
                    this.setupEventListeners();
                    this.showConnectionStatus();
                }

                setupEventListeners() {
                    const messageInput = document.getElementById('messageInput');
                    const sendButton = document.getElementById('sendButton');

                    // Ø§Ø±Ø³Ø§Ù„ Ø¨Ø§ Enter
                    messageInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter' && !e.shiftKey) {
                            e.preventDefault();
                            this.sendMessage();
                        }
                    });

                    // ØªÙ†Ø¸ÛŒÙ… Ø§Ø±ØªÙØ§Ø¹ Ø®ÙˆØ¯Ú©Ø§Ø± textarea
                    messageInput.addEventListener('input', (e) => {
                        e.target.style.height = 'auto';
                        e.target.style.height = Math.min(e.target.scrollHeight, 120) + 'px';
                    });

                    // Ø¨Ø±Ø±Ø³ÛŒ Ø¢Ù†Ù„Ø§ÛŒÙ†/Ø¢ÙÙ„Ø§ÛŒÙ†
                    window.addEventListener('online', () => this.handleConnectionChange(true));
                    window.addEventListener('offline', () => this.handleConnectionChange(false));
                }

                async sendMessage() {
                    const input = document.getElementById('messageInput');
                    const message = input.value.trim();
                    
                    if (!message) return;

                    // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù¾ÛŒØ§Ù… Ú©Ø§Ø±Ø¨Ø±
                    this.addMessage(message, 'user');
                    input.value = '';
                    input.style.height = 'auto';

                    // ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø¯Ú©Ù…Ù‡ Ø§Ø±Ø³Ø§Ù„
                    document.getElementById('sendButton').disabled = true;

                    // Ù†Ù…Ø§ÛŒØ´ ÙˆØ¶Ø¹ÛŒØª ØªØ§ÛŒÙ¾
                    this.showTypingIndicator();

                    try {
                        const response = await fetch('/api/chat/send', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                message: message, 
                                user_id: 'web-user',
                                post_id: 126,
                                timestamp: new Date().toISOString()
                            })
                        });
                        
                        const data = await response.json();
                        
                        // Ù¾Ù†Ù‡Ø§Ù† Ú©Ø±Ø¯Ù† ÙˆØ¶Ø¹ÛŒØª ØªØ§ÛŒÙ¾
                        this.hideTypingIndicator();
                        
                        // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù¾Ø§Ø³Ø® Ø±Ø¨Ø§Øª
                        this.addMessage(data.bot_response, 'bot', data);
                        
                    } catch (error) {
                        this.hideTypingIndicator();
                        this.addMessage('Ù…ØªØ£Ø³ÙØ§Ù†Ù‡ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ± Ù…Ø´Ú©Ù„ÛŒ Ù¾ÛŒØ´ Ø¢Ù…Ø¯Ù‡. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.', 'bot');
                        console.error('Error:', error);
                    } finally {
                        document.getElementById('sendButton').disabled = false;
                    }
                }

                addMessage(content, type, data = {}) {
                    const message = {
                        id: Date.now(),
                        content,
                        type,
                        timestamp: new Date().toISOString(),
                        ...data
                    };

                    this.messages.push(message);
                    this.saveMessages();
                    this.renderMessage(message);
                    this.scrollToBottom();
                }

                renderMessage(message) {
                    const container = document.getElementById('messagesContainer');
                    const messageElement = document.createElement('div');
                    
                    messageElement.className = `message message-${message.type}`;
                    messageElement.innerHTML = `
                        <div class="message-content">${this.formatMessage(message.content)}</div>
                        <span class="message-time">${new Date(message.timestamp).toLocaleTimeString('fa-IR')}</span>
                        <div class="message-actions">
                            <button class="action-btn" onclick="copyMessage('${message.id}')">
                                <i class="fas fa-copy"></i>
                            </button>
                            <button class="action-btn" onclick="deleteMessage('${message.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;

                    container.appendChild(messageElement);
                }

                formatMessage(content) {
                    // ØªØ¨Ø¯ÛŒÙ„ Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ Ø¨Ù‡ ØªÚ¯ <a>
                    const urlRegex = /(https?:\/\/[^\s]+)/g;
                    return content.replace(urlRegex, url => 
                        `<a href="${url}" target="_blank" style="color: inherit; text-decoration: underline;">${url}</a>`
                    );
                }

                showTypingIndicator() {
                    document.getElementById('typingIndicator').classList.add('show');
                    this.scrollToBottom();
                }

                hideTypingIndicator() {
                    document.getElementById('typingIndicator').classList.remove('show');
                }

                scrollToBottom() {
                    const container = document.getElementById('messagesContainer');
                    container.scrollTop = container.scrollHeight;
                }

                saveMessages() {
                    localStorage.setItem('chatMessages', JSON.stringify(this.messages));
                }

                loadMessages() {
                    const container = document.getElementById('messagesContainer');
                    container.innerHTML = '';
                    
                    this.messages.forEach(message => this.renderMessage(message));
                    this.scrollToBottom();
                }

                clearMessages() {
                    if (confirm('Ø¢ÛŒØ§ Ø§Ø² Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ØªÙ…Ø§Ù… Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')) {
                        this.messages = [];
                        this.saveMessages();
                        this.loadMessages();
                        
                        // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù¾ÛŒØ§Ù… Ø®ÙˆØ´â€ŒØ¢Ù…Ø¯Ú¯ÙˆÛŒÛŒ
                        this.addMessage('Ø³Ù„Ø§Ù…! ğŸ‘‹ Ú†Øª Ù¾Ø§Ú© Ø´Ø¯. Ú†Ú¯ÙˆÙ†Ù‡ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ù… Ú©Ù…Ú© Ú©Ù†Ù…ØŸ', 'bot');
                    }
                }

                setTheme(theme) {
                    this.theme = theme;
                    document.documentElement.setAttribute('data-theme', theme);
                    localStorage.setItem('chatTheme', theme);
                    
                    // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ ØªÙ…
                    document.querySelectorAll('.theme-option').forEach(option => {
                        option.classList.toggle('active', option.dataset.theme === theme);
                    });
                }

                toggleTheme() {
                    const newTheme = this.theme === 'light' ? 'dark' : 'light';
                    this.setTheme(newTheme);
                }

                handleConnectionChange(online) {
                    this.isOnline = online;
                    this.showConnectionStatus();
                }

                showConnectionStatus() {
                    const statusElement = document.getElementById('connectionStatus');
                    
                    if (this.isOnline) {
                        statusElement.style.background = 'var(--success-color)';
                        statusElement.innerHTML = '<i class="fas fa-wifi"></i> Ù…ØªØµÙ„ Ø´Ø¯';
                    } else {
                        statusElement.style.background = 'var(--danger-color)';
                        statusElement.innerHTML = '<i class="fas fa-wifi-slash"></i> Ø§ØªØµØ§Ù„ Ù‚Ø·Ø¹ Ø´Ø¯';
                    }
                    
                    statusElement.classList.add('show');
                    setTimeout(() => statusElement.classList.remove('show'), 3000);
                }

                searchMessages(query) {
                    if (!query.trim()) {
                        this.loadMessages();
                        return;
                    }

                    const filteredMessages = this.messages.filter(message => 
                        message.content.toLowerCase().includes(query.toLowerCase())
                    );

                    const container = document.getElementById('messagesContainer');
                    container.innerHTML = '';
                    
                    filteredMessages.forEach(message => this.renderMessage(message));
                }
            }

            // Ø§ÛŒØ¬Ø§Ø¯ instance Ø§Ø² ChatManager
            const chatManager = new ChatManager();

            // ØªÙˆØ§Ø¨Ø¹ global Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø¯Ø± HTML
            function sendMessage() {
                chatManager.sendMessage();
            }

            function clearChat() {
                chatManager.clearMessages();
            }

            function toggleTheme() {
                chatManager.toggleTheme();
            }

            function setTheme(theme) {
                chatManager.setTheme(theme);
            }

            function toggleSidebar() {
                document.getElementById('sidebar').classList.toggle('open');
            }

            function copyMessage(messageId) {
                const message = chatManager.messages.find(m => m.id == messageId);
                if (message) {
                    navigator.clipboard.writeText(message.content).then(() => {
                        alert('Ù¾ÛŒØ§Ù… Ú©Ù¾ÛŒ Ø´Ø¯!');
                    });
                }
            }

            function deleteMessage(messageId) {
                if (confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ù¾ÛŒØ§Ù… Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')) {
                    chatManager.messages = chatManager.messages.filter(m => m.id != messageId);
                    chatManager.saveMessages();
                    chatManager.loadMessages();
                }
            }

            // Ù…Ø¯ÛŒØ±ÛŒØª Ø¬Ø³ØªØ¬Ùˆ
            document.getElementById('searchBox').addEventListener('input', (e) => {
                chatManager.searchMessages(e.target.value);
            });

            // Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ø±Ø³Ø§Ù„ ÙØ§ÛŒÙ„
            document.getElementById('fileInput').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    if (file.size > 5 * 1024 * 1024) { // 5MB limit
                        alert('Ø­Ø¬Ù… ÙØ§ÛŒÙ„ Ø¨Ø§ÛŒØ¯ Ú©Ù…ØªØ± Ø§Ø² Ûµ Ù…Ú¯Ø§Ø¨Ø§ÛŒØª Ø¨Ø§Ø´Ø¯.');
                        return;
                    }
                    
                    chatManager.addMessage(`ÙØ§ÛŒÙ„ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯Ù‡: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`, 'user');
                    
                    // Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ ÙØ§ÛŒÙ„ Ø±Ø§ Ø¢Ù¾Ù„ÙˆØ¯ Ú©Ù†ÛŒØ¯
                    console.log('File selected:', file);
                }
            });

            // Ø¨Ø³ØªÙ† Ø³Ø§ÛŒØ¯Ø¨Ø§Ø± Ø¨Ø§ Ú©Ù„ÛŒÚ© Ø®Ø§Ø±Ø¬
            document.addEventListener('click', (e) => {
                const sidebar = document.getElementById('sidebar');
                if (!sidebar.contains(e.target) && !e.target.closest('.btn[onclick="toggleSidebar()"]')) {
                    sidebar.classList.remove('open');
                }
            });

            // Ù„ÙˆØ¯ Ø§ÙˆÙ„ÛŒÙ‡
            window.addEventListener('load', () => {
                chatManager.scrollToBottom();
            });
        </script>
    </body>
    </html>
  `;
  return htmlResponse(html);
}

      // ğŸ¯ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª
      if (path === '/admin') {
        const html = `
          <!DOCTYPE html>
          <html dir="rtl" lang="fa">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>ğŸ¯ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª - Ù¾Ø³Øª Û±Û²Û¶</title>
            <style>
              * { margin: 0; padding: 0; box-sizing: border-box; }
              body { 
                font-family: 'Tahoma', 'Arial', sans-serif;
                direction: rtl;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                color: #333;
                padding: 20px;
              }
              .container { 
                max-width: 1200px;
                margin: 0 auto;
              }
              .card {
                background: white;
                border-radius: 20px;
                padding: 40px;
                box-shadow: 0 20px 40px rgba(0,0,0,0.1);
                margin: 20px 0;
              }
            </style>
          </head>
          <body>
            <div class="container">
              <div class="card">
                <h1>ğŸ¯ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª - Ù¾Ø³Øª Û±Û²Û¶</h1>
                <p>Ø§ÛŒÙ† Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ø³ÛŒØ³ØªÙ… Ù¾Ø³Øª Û±Û²Û¶ Ù…ÛŒâ€ŒØ¨Ø§Ø´Ø¯.</p>
                <a href="/" class="btn">ğŸ  Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ</a>
                
                <div style="margin-top: 30px; display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                  <div style="background: #e7f3ff; padding: 20px; border-radius: 10px;">
                    <h3>ğŸ“Š Ø¢Ù…Ø§Ø± Ø³ÛŒØ³ØªÙ…</h3>
                    <p>â€¢ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† ÙØ¹Ø§Ù„: Û±,Û²Û´Ûµ</p>
                    <p>â€¢ Ù…Ú©Ø§Ù„Ù…Ø§Øª Ø§Ù…Ø±ÙˆØ²: Û±Û²,ÛµÛ¸Û¹</p>
                    <p>â€¢ Ø¢Ù¾â€ŒØªØ§ÛŒÙ…: Û¹Û¹.Û¸Ùª</p>
                    <p>â€¢ Ù¾Ø³Øª: Û±Û²Û¶</p>
                  </div>
                  
                  <div style="background: #e7f3ff; padding: 20px; border-radius: 10px;">
                    <h3>ğŸ”§ ÙˆØ¶Ø¹ÛŒØª Ø³Ø±ÙˆÛŒØ³</h3>
                    <p>â€¢ Worker: ÙØ¹Ø§Ù„ âœ…</p>
                    <p>â€¢ API: Ø¯Ø± Ø¯Ø³ØªØ±Ø³ âœ…</p>
                    <p>â€¢ Ø¯ÛŒØªØ§Ø¨ÛŒØ³: Ù…ØªØµÙ„ âœ…</p>
                    <p>â€¢ Ø§Ø³ØªÙ‚Ø±Ø§Ø±: GitHub Actions</p>
                  </div>
                </div>
              </div>
            </div>
          </body>
          </html>
        `;
        return htmlResponse(html);
      }

      // Ø³Ø§ÛŒØ± Ù…Ø³ÛŒØ±Ù‡Ø§
      return jsonResponse({
        error: "Ù…Ø³ÛŒØ± ÛŒØ§ÙØª Ù†Ø´Ø¯",
        available_endpoints: ["/", "/chat", "/admin", "/api/chat/send", "/api/status"],
        post_id: 126
      }, 404);

    } catch (error) {
      return jsonResponse({
        error: "Ø®Ø·Ø§ÛŒ Ø³Ø±ÙˆØ±",
        message: error.message,
        post_id: 126
      }, 500);
    }
  }
};
